# Desafio consiste em:
criar uma aplica√ß√£o com OpenCms + Postgres + Linux + Nginx com proxy reverso. O objetivo final √© acessar a instala√ß√£o OpenCMS atrav√©s do NGINX com reverse proxy.

## Devo:
documentar todo o processo, passo a passo, fornecendo comandos utilizados

## Publicar no repo github
Toda a doc criada, incluir qualquer script, **arquivo de config** ou outros artefatos criados ou **MODIFICADOS** como parte do exercicio.

# Tarefas üöÄ
- [x] Baixar ISO Ubuntu 22.04
  - ‚ö†Ô∏è Coment√°rio importante sobre a tarefa 1
- [x] Baixar JDK 11
- [x] Baixar Tomcat 9.0.35
- [x] Baixar PostgreSQL 14
- [x] Baixar OpenCms13

- [] Baixar Nginx - Apesar de ser essencial e manter a seguran√ßa, pode ser configurado por √∫ltimo via acesso remoto da m√°quina onde ser√° feito o deploy do projeto.


Ap√≥s ler a doc, percebi que j√° existe uma imagem no Hub com o openCMS e as dependencias, por√©m o banco √© MariaDB.


Baixei uma VM do ubuntu 22.04 (jammy)
os seguintes comandos foram rodados:

# Permiss√£o de adm na VM

su -
admin
sudo adduser seu_usuario sudo
su seu_usuario

# atualizando pacotes
sudo apt-get update ; apt-get upgrade -y

# Atualizando JDK 11
sudo apt install openjdk-11-jdk

sudo update-alternatives --config java
escolha a JDK 11

sudo update-alternatives --config javac

- Confira as vers√µes:
java -version
javac -version

# Instalando PostgreSQL 14
sudo apt install postgresql-14

sudo systemctl status postgresql

sudo -u postgres psql

SELECT version();
q

\q


# Tomcat o gato...
https://dlcdn.apache.org


wget https://downloads.apache.org/tomcat/tomcat-9/v9.0.95/bin/apache-tomcat-9.0.95.tar.gz

tar -zxvf apache-tomcat-9.0.5.tar.gz

sudo mv apache-tomcat-9.0.5.tar.gz /opt/tomcat
/opt/tomcat/bin/./startup.sh

wget https://localhost:8080

*cat* no index.html que foi baixado pra confirmar caso n√£o seja feito na OS com GUI
cat index.html | grep successfully

## Retorno esperado:
> "If you're seeing this, you've **successfully** installed Tomcat. Congrats"


# Rodando OpenCms 13
http://www.opencms.org/downloads/opencms/opencms-13.0.zip
unzip opencms-13.0.zip

sudo mv opencms.war /opt/tomcat/webapps

Ele vai come√ßar a extrair uma pasta do 'opencms'

Quando tiver concluido, tentaremos acessar a URL do opencms


localhost:8080/opencms/setup

A partir de agora √© necess√°rio fazer uma configura√ß√£o no postgres para poder "liberar" o OpenCms abrir banco e uma database. [Configurando PostgreSQL](#configurando-postgresql-para-o-setup-do-opencms)


# Configurando Postgresql para o setup do OpenCms

https://www.youtube.com/watch?v=_fdhVbysbnw&t=6s

https://community.qlik.com/t5/Connectivity-Data-Prep/PostgreSQL-Password-forgot/td-p/2160246


Eu tive que alterar o pg_hba.conf para trust para acessar o postgres sem senha
- Alterar a senha do **postgres** para **postgres**

- Diret√≥rio:
sudo nano /etc/postgresql/14/main/pg_hba.conf

- Alterar as permiss√µes para trust do ipv4, ipv6, unix, tudo...

sair e trocar para
su -
su - postgres
psql
\password
nova senha = postgres
\q
exit
systemctl restart postgresql


- No OpenCms
Setup Connection:
postgres
postgres
template1

connection
opencms
opencms

DB Name: **opencms**
create db and user [x] Check
Create Tables [x] Check


# NGINX

sudo apt install nginx

sudo nano /etc/nginx/sites-available/default
ou
sudo nano /etc/nginx/conf.d/



server {
    listen 80;
    server_name localhost;

    location / {
        proxy_pass http://127.0.0.1:8080/opencms/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}


/etc/hosts 

Por√©m o site n√£o est√° indo, apesar de adicionar o localhost, ele meio que da uma sobrecarga e n√£o acessa a url certa.

Ainda n√£o encontrei documenta√ß√£o suficiente sobre fazer esse proxy acessar o opencms, parece que quando ele tenta chegar nessa url, o tomcat joga de volta pro localhost vazio




# DESCONTINUADO ###################################################
## JDK 17
sudo apt install openjdk-17-jdk

java -version

openjdk17 ou 11 - depende do opencms e do tomcat, ap√≥s o tomcat 10, j√° utiliza os pacotes Jakarta e n√£o mais java EE
## Tomcat o gato...
https://dlcdn.apache.org


wget https://dlcdn.apache.org/tomcat/tomcat-10/v10.1.30/bin/apache-tomcat-10.1.30.tar.gz

tar -zxvf apache-tomcat-10.1.30.tar.gz

sudo mv apache-tomcat-10.1.30.tar.gz /opt/tomcat
/opt/tomcat/bin/./startup.sh

wget https://localhost:8080

*cat* no index.html que foi baixado pra confirmar caso n√£o seja feito na OS com GUI
cat index.html | grep successfully

## Retorno esperado:
> "If you're seeing this, you've **successfully** installed Tomcat. Congrats"

## OpenCms
‚ö†Ô∏è Com o tomcat em execu√ß√£o, extrair o arquivo .WAR para dentro do diret√≥rio webapps do tomcat, dessa forma ele vai fazer o deploy do opencms.


wget http://www.opencms.org/downloads/opencms/opencms-17.0.zip

unzip opencms-17.0.zip

mv opencms.war /opt/tomcat/webapps

## - > DEPLOY ERRO TOMCAT/OPENCMS: 404 not found
Ap√≥s algumas tentativas, verificar logs e afins, n√£o consegui compreender o motivo de n√£o fazer o deploy com sucesso do opencms. Optei por remover as vers√µes atuais e tentar com uma vers√£o que use os pacotes java EE ao inv√©s do Jakarta.

Feito altera√ß√£o dos pacotes
Novos:

OpenCms 13
Tomcat 9.0.35

Obtive sucesso ao atingir o endpoint /opencms/setup

O processo com os arquivos √© o mesmo dos anteriores, consiste em instalar o tomcat na pasta /opt/tomcat
e extrair o arquivo do opencms dentro da pasta /opt/tomcat/webapps

Com os links novos √© poss√≠vel utilizar o mesmo passo a passo acima e atingir com sucesso o deploy do opencms
